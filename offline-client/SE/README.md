# 安全芯片存储Applet

## 项目简介

这是一个使用JavaCard技术开发的安全芯片存储Applet，可以安装在支持JavaCard的安全芯片中。该Applet提供基于用户名和地址的数据存储与检索功能，适用于需要离线存储数据的场景。

## 功能特性

- **数据存储**：将数据安全地存储在芯片内存中
- **数据检索**：通过用户名和地址查找并检索存储的数据
- **签名占位符**：读取数据的APDU命令包含一个签名字段作为占位符，当前版本不进行验证。
- **多记录管理**：支持存储多条记录，每条记录包含用户名、地址和消息数据
- **分段传输**：支持大数据分段传输，适用于大容量数据的传输
- **状态机管理**：采用状态机设计模式，确保操作序列的正确性
- **内存安全**：使用JavaCard提供的安全内存管理机制，防止内存溢出和信息泄露

## 技术架构

- **开发平台**：JavaCard 3.0.5+
- **内存管理**：混合使用永久存储(EEPROM)和临时存储(RAM)
- **通信协议**：标准APDU命令集

### 代码运行逻辑详解

#### 核心数据结构

1.  **记录存储结构**：
    -   `userNames`：存储所有用户名，总大小为`MAX_RECORDS * MAX_USERNAME_LENGTH`
    -   `userNameLengths`：记录每个用户名的实际长度
    -   `addresses`：存储所有地址，总大小为`MAX_RECORDS * MAX_ADDR_LENGTH`
    -   `addressLengths`：记录每个地址的实际长度
    -   `messages`：存储所有消息数据，总大小为`MAX_RECORDS * MAX_MESSAGE_LENGTH`
    -   `messageLengths`：记录每条消息的实际长度

2.  **内存管理**：
    -   永久存储(EEPROM)：用于存储用户记录和关键状态信息
    -   临时存储(RAM)：用于处理过程中的临时缓冲区，减少对永久内存的写入次数
    -   最大支持存储20条记录
    -   每个用户名最大32字节
    -   每个地址最大64字节
    -   每条消息最大1KB数据
    -   单次APDU通信最大240字节

3.  **状态机**：
    -   `OP_NONE`：空闲状态，可以接受新操作请求
    -   `OP_STORE`：存储数据状态，正在处理数据存储操作
    -   `OP_READ`：读取数据状态，正在处理数据读取操作

#### 执行流程

1.  **存储数据流程**：
    -   初始化阶段(`processStoreDataInit`)：验证当前状态为空闲，检查记录空间，存储用户名和地址，转换状态为`OP_STORE`
    -   数据传输阶段(`processStoreDataContinue`)：分段接收消息数据，存入永久存储
    -   完成阶段(`processStoreDataFinalize`)：更新记录计数，重置状态为空闲

2.  **读取数据流程**：
    -   初始化阶段(`processReadDataInit`)：验证当前状态为空闲，查找匹配记录（基于用户名和地址），转换状态为`OP_READ`，返回消息长度（忽略APDU中的签名占位符数据）
    -   数据传输阶段(`processReadDataContinue`)：分段返回消息数据，如果数据发送完毕自动重置状态
    -   可选完成阶段(`processReadDataFinalize`)：显式重置状态为空闲

### APDU命令接口

#### 命令格式概述

所有APDU命令的CLA固定为`0x80`，不同操作使用不同的INS值。

| 命令类型 | INS | 说明 |
|---------|-----|------|
| 存储初始化 | 0x10 | 启动存储过程，提供用户名和地址 |
| 存储继续 | 0x11 | 传输消息数据块 |
| 存储完成 | 0x12 | 结束存储过程 |
| 读取初始化 | 0x20 | 启动读取过程，提供用户名、地址和签名占位符 |
| 读取继续 | 0x21 | 获取消息数据块 |
| 读取完成 | 0x22 | 结束读取过程 |

#### 详细命令规范

##### 1. 存储数据

###### 存储初始化 (INS: 0x10)

CLA: 0x80 INS: 0x10 P1: 0x00 P2: 0x00 Lc: 数据长度 Data: [用户名长度(1)][用户名(变长)][地址长度(1)][地址(变长)]

###### 存储继续 (INS: 0x11)

CLA: 0x80 INS: 0x11 P1: 0x00 P2: 0x00 Lc: 数据块长度 Data: [消息数据块]

###### 存储完成 (INS: 0x12)

CLA: 0x80 INS: 0x12 P1: 0x00 P2: 0x00 Lc: 0


##### 2. 读取数据

###### 读取初始化 (INS: 0x20)

CLA: 0x80 INS: 0x20 P1: 0x00 P2: 0x00 Lc: 数据长度 Data: [用户名长度(1)][用户名(变长)][地址长度(1)][地址(变长)][签名长度(1)][签名占位符(变长)] Le: 0x02

响应: 两字节的消息长度（高字节在前）

###### 读取继续 (INS: 0x21)

CLA: 0x80 INS: 0x21 P1: 0x00 P2: 0x00 Le: 要读取的最大长度（通常为0xF0，即240字节）

响应: 消息数据块

###### 读取完成 (INS: 0x22)

CLA: 0x80 INS: 0x22 P1: 0x00 P2: 0x00 Lc: 0


#### 响应状态码

| 状态码 | 含义 | 可能原因 |
|-------|------|---------|
| 0x9000 | 操作正常完成 | 命令执行成功 |
| 0x6A83 | 记录不存在 | 查询的用户名和地址组合不存在 |
| 0x6A86 | 参数不正确 | P1P2参数错误 |
| 0x6700 | 长度错误 | 数据长度超出限制或格式错误 |
| 0x61xx | 更多数据可用 | 读取操作中还有更多数据可获取 (xx表示剩余字节数，最大为FF) |
| 0x6985 | 操作条件不满足 | 当前状态下不允许执行该操作 |
| 0x6A84 | 文件已满 | 记录数量已达上限 |
| 0x6E00 | CLA不支持 | CLA字节错误 |
| 0x6D00 | INS不支持 | INS字节错误 |

### 内存与性能考量

#### 内存限制

该Applet设计考虑到JavaCard平台的内存限制：

-   **最大记录数**：20条
-   **用户名最大长度**：32字节
-   **地址最大长度**：64字节
-   **消息最大长度**：1KB

总共最大内存占用约：

-   **用户名**：20 * 32 = 640字节
-   **地址**：20 * 64 = 1280字节
-   **消息**：20 * 1KB = 20KB
-   **元数据**：约500字节

*注意：对于资源受限的JavaCard，可能需要调整记录数量或每条记录的最大尺寸。*

#### 性能优化

-   **减少EEPROM写入**
    -   使用瞬态内存(RAM)存储临时数据
    -   在操作完成时才一次性写入EEPROM
-   **分段传输**
    -   单次最大传输240字节，避免超出APDU缓冲区限制
    -   支持大数据分段存储和读取
-   **快速查找**
    -   使用线性查找匹配记录（基于用户名和地址）
    -   对于大量记录，可以考虑实现更高效的索引结构

### 安全设计

#### 身份验证

-   访问控制依赖于物理访问安全卡和知道正确的用户名/地址组合。

#### 状态机设计

-   确保操作按正确顺序执行
-   防止中间状态的非法访问

#### 防御措施

-   **输入验证**
    -   对所有输入进行长度和边界检查
    -   防止缓冲区溢出攻击
-   **内存隔离**
    -   使用JavaCard提供的安全内存管理
    -   瞬态缓冲区在电源重置后自动清除
-   **错误处理**
    -   提供详细的错误状态码
    -   在异常情况下不泄露敏感信息

### 扩展开发建议

-   **引入签名验证**
    -   添加签名验证逻辑，并配置公钥。
    -   考虑使用安全的哈希算法（如SHA-256）。
-   **删除记录功能**
    -   添加删除指令以回收存储空间
    -   实现安全擦除，确保敏感数据不可恢复
-   **数据加密**
    -   将存储的消息数据进行加密
    -   使用对称或非对称加密保护数据机密性
-   **访问控制策略**
    -   实现更复杂的访问控制，例如基于PIN码或外部认证。
-   **事务支持**
    -   添加事务机制，防止写入操作中断导致数据不一致
    -   利用JavaCard的事务API

### 测试建议

-   **功能测试**
    -   验证所有指令的正常功能（存储、读取）
    -   测试边界条件(最大记录数、最大数据大小等)
    -   测试使用不存在的用户名/地址进行读取
-   **安全测试 (重点关注访问控制)**
    -   尝试在错误状态下执行操作
    -   评估仅依赖用户名/地址匹配的安全性风险
-   **性能测试**
    -   测量大数据传输性能
    -   评估内存使用情况
-   **兼容性测试**
    -   在不同JavaCard平台上测试
    -   测试与不同读卡器和中间件的兼容性

### 许可证

版权所有 © 2025 Security Chip Team