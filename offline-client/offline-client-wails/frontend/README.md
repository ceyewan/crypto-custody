# 多方门限签名系统

这是一个基于 Wails 的多方门限签名桌面应用，用于协调者、参与者和管理员之间的密钥生成和签名操作。

## 功能特性

- 用户注册与登录
- 基于角色的权限控制（管理员、协调者、参与者）
- 密钥生成流程
- 交易签名流程
- **安全芯片导入管理**（管理员专用）
- WebSocket 实时通信
- 本地 MPC 服务集成

## 系统架构

本系统采用混合架构，结合了云端服务和本地桌面应用：

### 云端后端服务
- **HTTPS API**：提供用户认证、会话创建、安全芯片管理等 HTTP 接口
- **WebSocket 服务**：提供实时通信，处理密钥生成和签名流程的协调

### 本地桌面应用 (Wails)
- **本地 MPC 服务**：通过 Wails 集成，提供密钥生成、签名计算等密码学操作
- **安全芯片访问**：通过 Wails 访问硬件安全芯片，获取 CPLC 数据
- **前端界面**：基于 Vue.js 的用户界面

## 用户角色

1. **管理员 (admin)**
   - 用户角色管理
   - 安全芯片导入管理
   - 密钥生成和签名协调

2. **协调者 (coordinator)**
   - 发起密钥生成请求
   - 发起交易签名请求

3. **参与者 (participant)**
   - 响应密钥生成邀请
   - 响应签名邀请

## 使用流程

### 系统初始化

1. **管理员设置**
   - 使用管理员账户登录系统
   - 在"用户管理"页面为其他用户分配正确的角色

2. **安全芯片导入（管理员专用）**
   - 将安全芯片插入读卡器
   - 进入"导入安全芯片"页面
   - 输入芯片上标识的 SEID（如 SE001、SE999 等）
   - 点击"获取 CPLC 并导入"按钮
   - 系统自动从安全芯片读取 CPLC 数据并注册到云端后台

### 密钥生成流程

**协调者操作：**
1. 登录后进入"密钥生成"页面
2. 设置门限签名参数：
   - **门限值 (threshold)**：完成签名所需的最少参与者数量
   - **总分片数 (parties)**：总参与者数量（必须 ≥ 门限值）
3. 从可用参与者列表中选择参与者
4. 点击"发起密钥生成"按钮
5. 系统创建密钥生成会话并向选中的参与者发送邀请

**参与者操作：**
1. 收到密钥生成邀请通知（页面会自动跳转到"通知消息"）
2. 在通知列表中查看邀请详情：
   - 协调者信息
   - 门限参数
   - 会话ID
3. 点击"接受"按钮确认参与
4. 系统自动调用本地 MPC 服务执行密钥生成计算
5. 计算完成后，密钥分片自动保存到本地

**流程完成：**
- 当所有参与者都接受邀请后，系统开始并行执行密钥生成
- 协调者和参与者都会收到密钥生成完成的通知
- 生成的公钥地址会显示在通知中，私钥分片安全存储在各参与者本地

### 交易签名流程

**协调者操作：**
1. 进入"交易签名"页面
2. 填写签名参数：
   - **公钥地址**：要使用的多方公钥地址（从密钥生成中获得）
   - **消息哈希**：要签名的交易哈希值
3. 系统自动获取该公钥对应的可用参与者列表
4. 从列表中选择足够数量的参与者（≥ 门限值）
5. 点击"发起签名"按钮
6. 系统创建签名会话并发送邀请

**参与者操作：**
1. 收到签名邀请通知
2. 查看签名请求详情：
   - 公钥地址
   - 要签名的消息哈希
   - 协调者信息
3. 点击"接受"按钮确认参与签名
4. 系统自动：
   - 从本地加载对应的私钥分片
   - 调用本地 MPC 服务执行签名计算
   - 生成部分签名并发送给协调者

**签名聚合：**
- 当收集到足够数量的部分签名后，系统自动进行签名聚合
- 生成完整的 ECDSA 签名（r, s 值）
- 协调者和参与者都会收到签名完成的通知
- 最终签名可用于区块链交易提交

## 注意事项

- 确保云端后端服务正常运行并可访问
- 安全芯片导入功能需要物理安全芯片和读卡器硬件支持
- 密钥生成时，参与者数量必须大于等于门限值
- 签名时，需要确保有足够数量的参与者在线并持有对应的私钥分片
- 系统会自动处理网络重连和错误恢复
- 所有私钥分片都安全存储在参与者本地，不会上传到服务器