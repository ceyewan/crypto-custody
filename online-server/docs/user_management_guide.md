# 用户管理模块开发指南

## 1. 概述

用户管理模块提供了完整的用户认证、授权和管理功能，主要包括：

- 用户注册和登录
- Token验证和刷新
- 用户权限控制
- 管理员对用户的管理功能

本文档主要面向开发人员，提供模块的设计思路、架构说明和开发指引。

## 2. 模块结构

用户管理模块采用分层架构设计，包含以下几个主要层次：

- **路由层 (route)**: 定义API路由和权限控制
- **处理器层 (handler)**: 处理HTTP请求和响应
- **服务层 (service)**: 实现业务逻辑
- **模型层 (model)**: 定义数据模型和数据库结构

### 2.1 文件结构

```
online-server/
├── route/
│   └── user.go          # 用户路由定义
├── handler/
│   └── user.go          # 用户请求处理函数
├── service/
│   └── user_service.go  # 用户服务实现
├── model/
│   └── users.go         # 用户模型定义
└── utils/
    ├── jwt.go           # JWT工具函数
    └── middleware.go    # 中间件定义
```

## 3. 用户认证流程

### 3.1 登录和认证

1. 用户提交用户名和密码到 `/api/login` 端点
2. 系统验证用户名和密码
3. 验证成功后，系统生成JWT令牌并返回给客户端
4. 客户端存储令牌并在后续请求的 `Authorization` 头中使用

### 3.2 Token验证

1. 客户端可以调用 `/api/check-auth` 端点检查令牌是否有效
2. 前端可以在路由导航守卫中使用此功能，当令牌无效时跳转到登录页面

### 3.3 登出流程

1. 用户调用 `/api/users/logout` 端点
2. 系统将用户的令牌加入黑名单
3. 客户端清除本地存储的令牌

## 4. 权限控制

系统定义了三种用户角色，每种角色有不同的权限级别：

- **管理员 (admin)**: 可以访问所有功能，包括用户管理
- **警员 (officer)**: 可以访问基本功能和特定的警员功能
- **游客 (guest)**: 只能访问基本功能

权限控制通过中间件实现，主要中间件包括：

- **JWTAuth**: 验证用户是否已登录
- **AdminRequired**: 验证用户是否具有管理员权限
- **OfficerRequired**: 验证用户是否具有警员或管理员权限

## 5. 管理员功能

管理员可以对非管理员用户执行以下操作：

1. **查看用户列表**: 获取系统中所有用户的信息
2. **查看指定用户**: 获取特定用户的详细信息
3. **更新用户名**: 修改非管理员用户的用户名 (ID)
4. **更新用户角色**: 修改非管理员用户的角色
5. **删除用户**: 从系统中删除非管理员用户

为保护系统安全，管理员不能修改其他管理员的信息。

## 6. 开发指南

### 6.1 添加新的用户功能

如需添加新的用户功能，请按照以下步骤：

1. 在 `route/user.go` 中添加新路由
2. 在 `handler/user.go` 中实现请求处理函数
3. 在 `service/user_service.go` 中实现业务逻辑
4. 如需新的数据结构，在 `model/users.go` 中定义

### 6.2 添加新的权限控制

如需添加新的权限控制规则：

1. 在 `utils/middleware.go` 中定义新的中间件函数
2. 在 `route/user.go` 中使用该中间件

### 6.3 修改用户模型

如需修改用户模型：

1. 更新 `model/users.go` 中的 `User` 结构
2. 创建数据库迁移脚本
3. 更新相关的处理函数和服务

## 7. 安全最佳实践

开发用户管理功能时，请遵循以下安全最佳实践：

1. **密码存储**: 始终使用安全的哈希算法（如 bcrypt）存储密码
2. **令牌管理**: 设置合理的令牌过期时间，并实现令牌刷新机制
3. **输入验证**: 对所有用户输入进行严格验证和清洗
4. **错误处理**: 避免在响应中泄露敏感信息
5. **权限检查**: 在每个敏感操作中都进行权限检查
6. **审计日志**: 记录所有敏感操作的日志

## 8. 测试指南

用户管理模块有两种测试方式：

### 8.1 单元测试

执行单元测试：

```bash
cd online-server
go test -v ./tests/user_test.go
```

### 8.2 集成测试

执行集成测试：

```bash
cd online-server
# 确保服务已启动
./tests/integration_test.sh localhost 8080
```

## 9. 常见问题与排错

1. **令牌无效**: 检查令牌是否过期或被撤销
2. **权限不足**: 确认用户角色是否正确设置
3. **数据库错误**: 检查数据库连接和表结构
4. **用户名/邮箱冲突**: 确保注册时检查用户名和邮箱的唯一性

## 10. API 参考

请参考 [用户管理API文档](user_management_api.md) 获取完整的API说明。