# 交易管理系统 API 文档

## 概述

交易管理系统提供了完整的以太坊交易功能，包括查询余额、准备交易、签名交易和发送交易等操作。系统采用在线-离线分离的安全架构，显著提高了私钥管理的安全性。

本文档主要描述API接口的使用方法、参数要求和返回值格式。

## 基础信息

- 基础URL: `/api/transaction`
- 所有请求和响应均使用JSON格式
- 需要认证的API需要在请求头中包含`Authorization`字段，值为登录时获取的令牌
- 所有响应都包含以下字段：
  - `code`: 状态码，200表示成功，其他值表示错误
  - `message`: 状态描述信息
  - `data`: 响应数据（可选）

## 公开API

### 1. 获取账户余额

- **路径**: `/balance/:address`
- **方法**: GET
- **描述**: 获取指定以太坊地址的ETH余额
- **参数**: `:address` - 以太坊地址（格式：0x开头的16进制字符串）
- **响应**:
  ```json
  {
    "code": 200,
    "message": "获取余额成功",
    "data": {
      "address": "0x1234567890abcdef1234567890abcdef12345678",
      "balance": "1.234567890123456789"
    }
  }
  ```
- **错误响应**:
  - 400: 地址参数不能为空
  - 500: 获取以太坊客户端失败
  - 500: 获取余额失败

## 需要认证的API

以下API需要具有警员或管理员权限，并且在请求头中包含有效的`Authorization`令牌。

### 1. 准备交易

- **路径**: `/tx/prepare`
- **方法**: POST
- **描述**: 准备交易数据，生成待签名的消息哈希
- **请求头**: `Authorization: 令牌值`
- **请求体**:
  ```json
  {
    "fromAddress": "0x1234567890abcdef1234567890abcdef12345678", // 发送方地址
    "toAddress": "0xabcdef1234567890abcdef1234567890abcdef12",   // 接收方地址
    "amount": "0.01"                                             // 转账金额（ETH）
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "交易准备成功",
    "data": {
      "transactionID": 123,
      "messageHash": "0x9876543210fedcba9876543210fedcba9876543210fedcba9876543210fedcba",
      "fromAddress": "0x1234567890abcdef1234567890abcdef12345678",
      "toAddress": "0xabcdef1234567890abcdef1234567890abcdef12",
      "amount": "0.01 ETH"
    }
  }
  ```
- **错误响应**:
  - 400: 请求参数不正确
  - 500: 获取以太坊客户端失败
  - 400: 发送方地址已有正在处理的交易，请等待完成
  - 500: 创建交易失败

### 2. 签名并发送交易

- **路径**: `/tx/sign-send`
- **方法**: POST
- **描述**: 使用签名数据验证并发送交易到以太坊网络
- **请求头**: `Authorization: 令牌值`
- **请求体**:
  ```json
  {
    "messageHash": "0x9876543210fedcba9876543210fedcba9876543210fedcba9876543210fedcba", // 消息哈希
    "signature": "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890ab" // 签名数据
  }
  ```
- **响应**:
  ```json
  {
    "code": 200,
    "message": "交易已发送到网络",
    "data": {
      "transactionID": 123,
      "txHash": "0xfedcba9876543210fedcba9876543210fedcba9876543210fedcba9876543210",
      "status": "Submitted"
    }
  }
  ```
- **错误响应**:
  - 400: 请求参数不正确
  - 500: 获取以太坊客户端失败
  - 400: 无效的消息哈希
  - 400: 无效的签名
  - 400: 交易已经发送
  - 500: 签名验证失败
  - 500: 发送交易失败

## 交易状态说明

交易在处理过程中会经历以下几种状态：

1. **Created**: 交易刚创建，等待签名
2. **Signed**: 交易已签名，等待发送到网络
3. **Submitted**: 交易已提交到以太坊网络，等待确认
4. **Confirmed**: 交易已被以太坊网络确认
5. **Failed**: 交易失败

## 错误码说明

- 200: 请求成功
- 400: 请求参数错误或业务错误
- 401: 未授权或令牌无效
- 403: 权限不足
- 500: 服务器内部错误

## 安全说明

1. 私钥应在安全的离线环境中保存和使用
2. 签名操作应在离线设备上进行，只将签名结果传递给在线系统
3. 大额交易建议先进行小额测试
4. 系统会记录所有交易操作的日志
